name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-backend:
    name: Test Backend (.NET)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore Suscripcion.Test/Suscripcion.Test.csproj
    
    - name: Build
      run: dotnet build Suscripcion.Test/Suscripcion.Test.csproj --no-restore --configuration Release
    
    - name: Run tests
      run: dotnet test Suscripcion.Test/Suscripcion.Test.csproj --no-build --configuration Release --verbosity normal --collect:"XPlat Code Coverage"
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        files: '**/coverage.cobertura.xml'
        fail_ci_if_error: false

  test-frontend:
    name: Test Frontend (React)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: suscripcion-frontend/package-lock.json
    
    - name: Install dependencies
      working-directory: ./suscripcion-frontend
      run: npm ci
    
    - name: Run tests
      working-directory: ./suscripcion-frontend
      run: npm test -- --coverage

  deploy-railway:
    name: Deploy to Railway
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Deployment Summary
      run: |
        echo "✅ Tests aprobados! Railway desplegará automáticamente ambos servicios:"
        echo "   Backend: https://suscribe-production.up.railway.app"
        echo "   Frontend: Configurar en el dashboard de Railway"
